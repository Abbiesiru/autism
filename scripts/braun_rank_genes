setwd("/home/abbiew/single_cell/braun")
seurat_paths <- list.files("./5_Saved_seurat_obj", pattern = "*.rds", full.names = TRUE)
tmp <- read.csv("/home/abbiew/single_cell/autism_risk_genes_combined.csv", sep = ",", header = TRUE)
asd_risk_genes <- tmp$Gene

library(Seurat)
library(AUCell)

cell_rankings_list <- list()

build_rankings <- function(path, genes) {
  seurat_obj <- readRDS(path)
  expr_mat <- GetAssayData(object = seurat_obj, assay = "RNA", slot = "counts")
  
  cell_rankings <- AUCell_buildRankings(
    expr_mat,
    plotStats = FALSE,
    keepZeroesAsNA = FALSE,
    verbose = TRUE
  )
  
  subset_rankings <- getRanking(cell_rankings)[rownames(cell_rankings) %in% genes, ]
  cell_rankings_list[[basename(path)]] <<- subset_rankings
}

lapply(seurat_paths, build_rankings, genes = asd_risk_genes)

# Ccmbine and normalize rankings
merged_cell_rankings <- do.call(cbind, cell_rankings_list)
merged_cell_rankings <- 1 - (merged_cell_rankings / 26261 * 100)

# Save combined matrix
saveRDS(merged_cell_rankings, file = "cell_rankings_braun.rds")
